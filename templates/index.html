<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Face Recognition Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-slate-950 text-slate-100">
    <div class="min-h-screen">
      <!-- Header -->
      <div class="border-b border-slate-800">
        <div
          class="mx-auto max-w-6xl px-4 py-4 flex items-center justify-between"
        >
          <div>
            <div class="text-xl font-semibold">Face Recognition</div>
            <div class="text-slate-400 text-sm">Flask dashboard</div>
          </div>

          <div class="flex gap-2">
            <button
              id="reloadBtn"
              class="rounded-lg bg-slate-800 hover:bg-slate-700 px-3 py-2 text-sm"
            >
              Reload faces
            </button>
          </div>
        </div>
      </div>

      <div
        class="mx-auto max-w-6xl px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6"
      >
        <!-- Video -->
        <div class="lg:col-span-2">
          <div
            class="rounded-xl border border-slate-800 bg-slate-900 overflow-hidden"
          >
            <div
              class="px-4 py-3 border-b border-slate-800 flex items-center justify-between"
            >
              <div class="font-medium">Live feed</div>
              <div class="text-xs text-slate-400" id="statusText">—</div>
              <button
                id="startBtn"
                class="rounded-lg bg-emerald-600 hover:bg-emerald-500 px-3 py-2 text-sm font-medium"
              >
                Start
              </button>
              <button
                id="stopBtn"
                class="rounded-lg bg-rose-600 hover:bg-rose-500 px-3 py-2 text-sm font-medium"
              >
                Stop
              </button>
            </div>
            <div class="p-3">
              <img id="videoFeed" class="w-full ..." src="" alt="video" />
            </div>
          </div>

          <div class="mt-6 rounded-xl border border-slate-800 bg-slate-900">
            <div class="px-4 py-3 border-b border-slate-800">
              <div class="font-medium">Attendance</div>
              <div class="text-xs text-slate-400" id="attendanceMeta">
                Marks once per server run
              </div>
            </div>

            <div id="attendanceList" class="p-4 space-y-2"></div>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
          <!-- Upload -->
          <div class="rounded-xl border border-slate-800 bg-slate-900">
            <div class="px-4 py-3 border-b border-slate-800">
              <div class="font-medium">Add training image</div>
              <div class="text-xs text-slate-400">
                Saves as 1.jpg, 2.jpg, … in faces/&lt;person&gt;/
              </div>
            </div>

            <form
              id="uploadForm"
              class="p-4 space-y-4"
              enctype="multipart/form-data"
            >
              <div class="space-y-2">
                <div class="text-sm text-slate-300">Person</div>
                <div class="flex items-center gap-3">
                  <label class="flex items-center gap-2 text-sm">
                    <input
                      type="radio"
                      name="mode"
                      value="existing"
                      checked
                      class="accent-slate-200"
                    />
                    Existing
                  </label>
                  <label class="flex items-center gap-2 text-sm">
                    <input
                      type="radio"
                      name="mode"
                      value="new"
                      class="accent-slate-200"
                    />
                    New
                  </label>
                </div>

                <select
                  id="existingName"
                  name="existing_name"
                  class="w-full rounded-lg bg-slate-950 border border-slate-800 px-3 py-2 text-sm"
                ></select>

                <input
                  id="newName"
                  name="new_name"
                  placeholder="e.g. Ahmed_AlQahtani"
                  class="w-full rounded-lg bg-slate-950 border border-slate-800 px-3 py-2 text-sm hidden"
                />
                <div class="text-xs text-slate-400">
                  Folder names are sanitized (letters/numbers/_-).
                </div>
              </div>

              <div class="space-y-2">
                <div class="text-sm text-slate-300">Image</div>
                <input
                  name="file"
                  type="file"
                  accept="image/*"
                  required
                  class="w-full text-sm text-slate-200 file:mr-3 file:rounded-lg file:border-0 file:bg-slate-800 file:px-3 file:py-2 file:text-sm file:text-slate-100 hover:file:bg-slate-700"
                />
              </div>

              <button
                type="submit"
                class="w-full rounded-lg bg-emerald-600 hover:bg-emerald-500 px-3 py-2 text-sm font-medium"
              >
                Upload
              </button>

              <div id="uploadMsg" class="text-xs text-slate-300"></div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>
      // --- DOM (guarded, since some sections may be removed) ---
      const peopleListEl = document.getElementById("peopleList");
      const peopleCountEl = document.getElementById("peopleCount");
      const existingSelect = document.getElementById("existingName");
      const newNameInput = document.getElementById("newName");
      const uploadMsg = document.getElementById("uploadMsg");
      const statusText = document.getElementById("statusText");
      const videoFeed = document.getElementById("videoFeed");
      const startBtn = document.getElementById("startBtn");
      const stopBtn = document.getElementById("stopBtn");
      const attendanceListEl = document.getElementById("attendanceList");
      const attendanceMetaEl = document.getElementById("attendanceMeta");
      const toastContainer = document.getElementById("toastContainer");

      let attendanceES = null;

      // --- stream control ---
      function startStream() {
        if (!videoFeed) return;
        videoFeed.src = "/video?ts=" + Date.now(); // bust cache
      }

      function stopStream() {
        if (!videoFeed) return;
        videoFeed.removeAttribute("src");
        videoFeed.src = "";
      }

      function setRunningUI(running) {
        running = !!running;

        if (statusText)
          statusText.textContent = running
            ? "Camera running"
            : "Camera stopped";

        if (startBtn) {
          startBtn.disabled = running;
          startBtn.classList.toggle("opacity-50", running);
        }
        if (stopBtn) {
          stopBtn.disabled = !running;
          stopBtn.classList.toggle("opacity-50", !running);
        }

        // Keep MJPEG aligned
        if (running) {
          if (videoFeed && !videoFeed.getAttribute("src")) startStream();
        } else {
          if (videoFeed && videoFeed.getAttribute("src")) stopStream();
        }
      }

      function renderAttendance(roster) {
        if (!attendanceListEl) return;
        roster = roster || [];
        attendanceListEl.innerHTML = roster.length
          ? roster.map(renderAttendanceRow).join("")
          : `<div class="text-sm text-slate-400">No attendance yet.</div>`;
      }

      function connectAttendanceStream() {
        if (attendanceES) return;

        attendanceES = new EventSource("/api/attendance/stream");

        attendanceES.addEventListener("state", (e) => {
          const j = JSON.parse(e.data);
          setRunningUI(!!j.running);
          renderAttendance(j.attendance || []);
        });

        attendanceES.addEventListener("new", (e) => {
          const ev = JSON.parse(e.data);
          toast(`✅ Marked attendance: ${ev.name}`, "success");
        });

        attendanceES.addEventListener("repeat", (e) => {
          const ev = JSON.parse(e.data);
          toast(`ℹ️ ${ev.name} has already attended`, "warn");
        });

        attendanceES.onerror = () => {
          // Browser auto-reconnects. Optional: show “reconnecting…”
        };
      }

      window.addEventListener("beforeunload", () => {
        if (attendanceES) attendanceES.close();
        attendanceES = null;
      });

      // Call once on startup:
      connectAttendanceStream();

      // --- toast ---
      function toast(message, kind = "info") {
        if (!toastContainer) return;

        const el = document.createElement("div");
        el.className =
          "rounded-lg border border-slate-700 bg-slate-900/95 px-3 py-2 text-sm shadow-lg";

        if (kind === "success") el.classList.add("border-emerald-700");
        if (kind === "warn") el.classList.add("border-amber-700");

        el.textContent = message;
        toastContainer.appendChild(el);

        setTimeout(() => {
          el.classList.add("opacity-0");
          setTimeout(() => el.remove(), 250);
        }, 2500);
      }

      function fmtTime(ts) {
        if (!ts) return "—";
        try {
          return new Date(ts * 1000).toLocaleTimeString();
        } catch {
          return "—";
        }
      }

      function renderAttendanceRow(p) {
        const present = !!p.present;
        const dot = present
          ? '<span class="inline-block h-2 w-2 rounded-full bg-emerald-400"></span>'
          : '<span class="inline-block h-2 w-2 rounded-full bg-slate-600"></span>';

        return `
          <div class="flex items-center justify-between rounded-lg border border-slate-800 bg-slate-950 px-3 py-2">
            <div class="flex items-center gap-3">
              ${dot}
              <div class="text-sm font-medium">${p.name}</div>
            </div>
            <div class="text-xs text-slate-400">First seen: ${fmtTime(p.first_seen_ts)}</div>
          </div>
        `;
      }

      // --- Mode UI for upload ---
      function currentMode() {
        return (
          document.querySelector('input[name="mode"]:checked')?.value ||
          "existing"
        );
      }

      function setModeUI() {
        const mode = currentMode();
        if (!newNameInput || !existingSelect) return;

        if (mode === "new") {
          newNameInput.classList.remove("hidden");
          existingSelect.classList.add("hidden");
        } else {
          newNameInput.classList.add("hidden");
          existingSelect.classList.remove("hidden");
        }
      }

      document.querySelectorAll('input[name="mode"]').forEach((r) => {
        r.addEventListener("change", setModeUI);
      });

      // --- People list (for dropdown; grid section can be removed safely) ---
      async function refreshPeople() {
        const r = await fetch("/api/people");
        const j = await r.json();
        const people = j.people || [];

        if (peopleCountEl) peopleCountEl.textContent = `${people.length} total`;
        if (peopleListEl) {
          // If you remove the People grid section, this element may not exist — guarded.
          // (No-op if missing.)
        }

        if (existingSelect) {
          existingSelect.innerHTML = people.length
            ? people
                .map(
                  (p) =>
                    `<option value="${p.name}">${p.name} (${p.count})</option>`,
                )
                .join("")
            : `<option value="">(no people yet)</option>`;
        }
      }

      // --- Buttons ---
      startBtn.onclick = async () => {
        await fetch("/api/start", { method: "POST" });
        // UI/stream will be aligned by SSE "state" event
      };

      stopBtn.onclick = async () => {
        await fetch("/api/stop", { method: "POST" });
        stopStream(); // close MJPEG immediately client-side
      };

      // --- Reload faces ---
      const reloadBtn = document.getElementById("reloadBtn");
      if (reloadBtn) {
        reloadBtn.onclick = async () => {
          await fetch("/api/reload_faces", { method: "POST" });
          await refreshPeople();
          if (uploadMsg) uploadMsg.textContent = "Reloaded.";
        };
      }

      // --- Upload ---
      const uploadForm = document.getElementById("uploadForm");
      if (uploadForm) {
        uploadForm.onsubmit = async (e) => {
          e.preventDefault();
          if (uploadMsg) uploadMsg.textContent = "Uploading...";

          const fd = new FormData(e.target);
          fd.set("mode", currentMode());

          const r = await fetch("/api/upload_face", {
            method: "POST",
            body: fd,
          });
          const j = await r.json();

          if (!r.ok) {
            if (uploadMsg)
              uploadMsg.textContent = "Error: " + (j.error || "upload failed");
            return;
          }

          if (uploadMsg)
            uploadMsg.textContent = `Saved to ${j.person}/ (reloaded embeddings)`;
          await refreshPeople();
        };
      }

      // --- initial ---
      setModeUI();
      refreshPeople();
    </script>
  </body>
</html>
